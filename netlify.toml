# netlify.toml
[build]
  publish = "."
  command = "npm run build"
  functions = "functions"

[build.environment]
  NODE_VERSION = "18"
  NPM_VERSION = "9"

# Configuration du CMS Netlify
[build.environment]
  # Activer Identity et Git Gateway
  ENABLE_GIT_GATEWAY = "true"
  
  # Configuration pour les médias
  MEDIA_FOLDER = "public/img/uploads"
  PUBLIC_FOLDER = "/img/uploads"

# Redirections
[[redirects]]
  from = "/admin/*"
  to = "/admin/index.html"
  status = 200

# Redirection pour les assets du CMS
[[redirects]]
  from = "/img/uploads/*"
  to = "/public/img/uploads/:splat"
  status = 200

# Redirection pour le contenu
[[redirects]]
  from = "/content/*"
  to = "/content/:splat"
  status = 200

# Redirection pour les pages principales
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# Redirections spécifiques pour SPA
[[redirects]]
  from = "/blog"
  to = "/blog.html"
  status = 200

[[redirects]]
  from = "/article/*"
  to = "/article.html"
  status = 200

# Headers de sécurité
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Content-Security-Policy = """
      default-src 'self';
      script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://identity.netlify.com https://unpkg.com https://*.googleapis.com;
      style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com;
      img-src 'self' data: https: http:;
      font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com;
      connect-src 'self' https://*.netlify.com https://*.netlify.app;
      frame-src 'self' https://identity.netlify.com;
    """
    Strict-Transport-Security = "max-age=31536000; includeSubDomains"

# Headers pour le CMS
[[headers]]
  for = "/admin/*"
  [headers.values]
    Content-Security-Policy = """
      default-src 'self';
      script-src 'self' 'unsafe-inline' https://identity.netlify.com https://unpkg.com;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: https:;
      font-src 'self' data:;
      connect-src 'self' https://api.github.com https://*.netlify.com https://*.netlify.app;
    """

# Cache pour les assets statiques
[[headers]]
  for = "/css/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/js/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/img/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Pas de cache pour les pages HTML
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# Configuration pour Identity (authentification)
[context.production.environment]
  # URL de votre site en production
  URL = "https://centre-dentaire-el-amri.com"

# Configuration pour les branches de développement
[context.deploy-preview.environment]
  # Activer le preview pour les PR
  NETLIFY_PREVIEW = "true"

# Configuration pour les fonctions serverless (optionnel)
# [[functions]]
#   directory = "functions"

# Plugins Netlify
[[plugins]]
  package = "@netlify/plugin-sitemap"
  
[[plugins]]
  package = "netlify-plugin-cache"
  
[[plugins]]
  package = "@netlify/plugin-lighthouse"

# Configuration pour sitemap
[context.production.environment]
  SITEMAP_PATTERN = "https://centre-dentaire-el-amri.com/**/*.html"

# Configuration pour le déploiement continu
[context.deploy-preview]
  command = "npm run build"
  publish = "."

[context.branch-deploy]
  command = "npm run build"
  publish = "."

# Configuration pour les formulaires (optionnel)
[forms]
  # Activer la détection automatique des formulaires
  enable = true

  [forms.honeypot]
    # Activer le honeypot pour éviter le spam
    enable = true
    field_name = "bot-field"

# Configuration pour les split tests (A/B testing)
# [split_tests]
#   [[split_tests.test]]
#     name = "Homepage Test"
#     paths = ["/"]
#     branches = ["main", "experiment"]

# Variables d'environnement (sécurisées)
[context.production.environment]
  # Pour Google Analytics (optionnel)
  GA_TRACKING_ID = "UA-XXXXXXXXX-X"
  
  # Pour d'autres services
  SITE_URL = "https://centre-dentaire-el-amri.com"

# Configuration pour le build en parallèle
[build.processing]
  css = { bundle = true, minify = true }
  js = { bundle = true, minify = true }
  html = { pretty_urls = true }
  images = { compress = true }

# Configuration pour les médias
[build.processing.images]
  compress = true
  resize = [
    { width = 400, suffix = "-small" },
    { width = 800, suffix = "-medium" },
    { width = 1200, suffix = "-large" }
  ]